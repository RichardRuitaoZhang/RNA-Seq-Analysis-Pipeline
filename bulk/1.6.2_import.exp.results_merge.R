# Title: Prepare RSEM Output for DESeq2 Using tximport
# Author: Group 7
# Date: 2024-11-25
# Project: Final Project for BMD_ENG_311
# Description:
#     This script uses the tximport package to organize gene-level expression
#     data generated by RSEM. The processed expression matrix is prepared for
#     downstream analysis in DESeq2.

# set working dir
setwd("/Users/richardzhang/Desktop/Northwestern/Y1/BME_311/Final Project/data/")

# read in
samples_pc9 <- read.csv('colData.csv', nrows = 9)

# set file path
dir <- "/Users/richardzhang/Desktop/Northwestern/Y1/BME_311/Final Project/data/GSE162045_RAW/"
filename <- paste0(samples_pc9$running_id, "_PC9_", seq(1, 9), ".txt.gz")
# get file paths
files_pc9 <- file.path(dir, filename)
names(files_pc9) <- c(
  paste0("untreated_", 1:3),       # First 3 names: untreated1, untreated2, untreated3
  paste0("gefitinib-treated_day 3_", 1:3),          # Next 3 names: day 3_1, day 3_2, day 3_3
  paste0("gefitinib-treated_day 9_", 1:3)           # Last 3 names: day 9_1, day 9_2, day 9_3
)

### run this line when using GEO downloaded Supplementary file
# Initialize an empty list to store data frames
data_list <- lapply(files_pc9, function(file) {
  # Read each file
  data <- read.table(file, header = TRUE, stringsAsFactors = FALSE)
  # Rename the second column to match the sample name (use file name without extension)
  colnames(data)[2] <- gsub("\\.txt\\.gz$", "", basename(file))
  return(data)
})

# Merge all data frames by "ID"
merged_data <- Reduce(function(x, y) merge(x, y, by = "feature", all = TRUE), data_list)

# Set rownames to "ID" and drop the column
rownames(merged_data) <- merged_data$feature
count_matrix <- merged_data[, -1]

# save expression matrix
write.csv(count_matrix, "PC9_expression_matrix.csv")

samples_pc9$file_id <- paste0(samples_pc9$running_id, "_PC9_", seq(1, 9))
write.csv(samples_pc9, "colData.csv", row.names = FALSE)

### run this line when using RSEM output expression data
count_matrix <- tximport(files_pc9, type = "rsem", txIn = FALSE, txOut = FALSE)

### print final expression matrix
head(count_matrix$counts)