# Title: Prepare RSEM Output for DESeq2 Using tximport
# Author: Group 7
# Date: 2024-11-25
# Project: Final Project for BMD_ENG_311
# Description:
#     This script uses the tximport package to organize gene-level expression
#     data generated by RSEM. The processed expression matrix is prepared for
#     downstream analysis in DESeq2.

# set working dir
setwd("/Users/richardzhang/Desktop/Northwestern/Y1/BME_311/Final Project/data/")

# read in coldata for skmel28
samples_skmel28 <- read.csv('colData.csv')
samples_skmel28 <- tail(samples_skmel28, 9)

### 1. run this line when using GEO downloaded Supplementary file
# set file path
dir <- "/Users/richardzhang/Desktop/Northwestern/Y1/BME_311/Final Project/data/GSE162045_RAW/"
filename <- paste0(samples_skmel28$running_id, "_SKMEL28_", seq(1, 9), ".txt.gz")
# get file paths
files_skmel28 <- file.path(dir, filename)
names(files_skmel28) <- c(
  paste0("untreated_", 1:3),       # First 3 names: untreated1, untreated2, untreated3
  paste0("dabrafenib-treated_day 3_", 1:3),          # Next 3 names: day 3_1, day 3_2, day 3_3
  paste0("dabrafenib-treated_day 9_", 1:3)           # Last 3 names: day 9_1, day 9_2, day 9_3
)

# Initialize an empty list to store data frames
data_list <- lapply(files_skmel28, function(file) {
  # Read each file
  data <- read.table(file, header = TRUE, stringsAsFactors = FALSE)
  # Rename the second column to match the sample name (use file name without extension)
  colnames(data)[2] <- gsub("\\.txt\\.gz$", "", basename(file))
  return(data)
})

# Merge all data frames by "ID"
merged_data <- Reduce(function(x, y) merge(x, y, by = "feature", all = TRUE), data_list)

# Set rownames to "ID" and drop the column
rownames(merged_data) <- merged_data$feature
count_matrix <- merged_data[, -1]

samples_skmel28$file_id <- paste0(samples_skmel28$running_id, "_SKMEL28_", seq(1, 9))



### 2. run this line when using RSEM output expression data
merged_data <- read.table("SKMEL28/SKMEL28_expression_matrix.txt", sep = "\t", header = T)
# Set rownames to "ID" and drop the column
rownames(merged_data) <- merged_data$X
count_matrix <- merged_data[, -1]

# Create the colname vector
colname <- c(
  "SKMEL28_Untreated_Sample_1", "SKMEL28_Untreated_Sample_2", "SKMEL28_Untreated_Sample_3",
  "SKMEL28_Day_3_Sample_1", "SKMEL28_Day_3_Sample_2", "SKMEL28_Day_3_Sample_3",
  "SKMEL28_Day_9_Sample_1", "SKMEL28_Day_9_Sample_2", "SKMEL28_Day_9_Sample_3"
)
colnames(count_matrix) <- colname

# add column IDs into coldata
samples_skmel28$file_id <- colnames(count_matrix)



### 3. save the generated expression and coldata
write.csv(samples_skmel28, "SKMEL28/colData_SKMEL28.csv", row.names = F)
# save expression matrix
write.csv(count_matrix, "SKMEL28/skmel28_expression_matrix.csv", row.names = T)

